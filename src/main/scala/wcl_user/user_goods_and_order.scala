package wcl_user

import org.apache.spark.sql.execution.datasources.hbase.HBaseTableCatalog
import org.apache.spark.sql.expressions.Window
import org.apache.spark.sql.functions._
import org.apache.spark.sql.{DataFrame, SparkSession, functions}

object user_goods_and_order {
  def main(args: Array[String]): Unit = {
    val spark = SparkSession.builder()
      .appName("goods_and_orders")
      .master("local")
      .getOrCreate()

    import spark.implicits._
    val get_id = functions.udf(string_last_3_char _)

    //行为数据

    def goods_catalog =
      s"""{
         |"table":{"namespace":"default", "name":"tbl_goods"},
         |"rowkey":"id",
         |"columns":{
         |"id":{"cf":"rowkey", "col":"id", "type":"long"},
         |"c_orderSn":{"cf":"cf", "col":"cOrderSn", "type":"string"},
         |"product_type":{"cf":"cf", "col":"productType", "type":"string"},
         |"product_name":{"cf":"cf", "col":"productName", "type":"string"}
         |}
         |}""".stripMargin

    def order_catalog =
      s"""{
         |"table":{"namespace":"default", "name":"tbl_orders"},
         |"rowkey":"id",
         |"columns":{
         |"id":{"cf":"rowkey", "col":"id", "type":"long"},
         |"member_id":{"cf":"cf", "col":"memberId", "type":"string"},
         |"payment_status":{"cf":"cf", "col":"paymentStatus", "type":"string"},
         |"modified":{"cf":"cf", "col":"modified", "type":"string"},
         |"payment_name":{"cf":"cf", "col":"paymentName", "type":"string"},
         |"order_status":{"cf":"cf", "col":"orderStatus", "type":"string"},
         |"orderSn":{"cf":"cf", "col":"orderSn", "type":"string"},
         |"order_amount":{"cf":"cf", "col":"orderAmount", "type":"string"},
         |"finish_time":{"cf":"cf", "col":"finishTime", "type":"string"}
         |}
         |}""".stripMargin

    //对应的df
    val goods_df: DataFrame = spark.read
      .option(HBaseTableCatalog.tableCatalog, goods_catalog)
      .format("org.apache.spark.sql.execution.datasources.hbase")
      .load()
    val order_df: DataFrame = spark.read
      .option(HBaseTableCatalog.tableCatalog, order_catalog)
      .format("org.apache.spark.sql.execution.datasources.hbase")
      .load()

    //1
    val good_order: DataFrame = goods_df.join(order_df, order_df.col("orderSn") === goods_df.col("c_orderSn"))
      .withColumn("member_id", get_id('member_id))
    //good_order.show(false)
    //+-------+----------------------+---------------+--------------------------------+------+---------+--------------+---------------------+------------+------------+----------------------+------------+-----------+
    //|id     |c_orderSn             |product_type   |product_name                    |id    |member_id|payment_status|modified             |payment_name|order_status|orderSn               |order_amount|finish_time|
    //+-------+----------------------+---------------+--------------------------------+------+---------+--------------+---------------------+------------+------------+----------------------+------------+-----------+
    //|3707613|140902208539685       |其他           |TS40经典版                      |5596  |535      |101           |2019-08-06 23:04:24.0|快捷通      |202         |140902208539685       |900.00      |1565103865 |
    //|3828175|140902208539685       |智能电视       |海尔电热水器EC5002-Q6           |5596  |535      |101           |2019-08-06 23:04:24.0|快捷通      |202         |140902208539685       |900.00      |1565103865 |

    //2
    //浏览的商品
    val user_scanned_goods_df = good_order.select('member_id, 'product_name).groupBy("member_id")
      .agg(collect_set('product_name).cast("string") as "scanned_goods")
    //user_scanned_goods_df.show(false)
    //show
    //+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    //|member_id|scanned_goods                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
    //+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    //|467      |[海尔冰箱BCD-228S1白, 海尔滚筒洗衣机XQG70-1012 家家爱, XQB55-Z1269, 统帅投影仪众筹isee mini 1S, 海尔冰箱BCD-196TMPI, 海尔冰箱BCD-231WDBB, XQB50-M1268 关爱, XQS60-Z9288  至爱, 海尔冰箱BC-93TMPF, TS40经典版, 海尔电磁炉 C21-H2110, 海尔波轮洗衣机XQB50-M1268 关爱, BC-50ES, 海尔滚筒洗衣机XQG60-S1086AM, XQBM20-10EW, 海尔波轮洗衣机XPB85-287S 关爱, XPB70-287BS 关爱, 统帅彩电TS48, 海尔空调KFR-35GW/05KBP22A(DS)套机, 海尔滚筒洗衣机XQG70-B10288, XQB50-M1258关爱, 海尔电压力锅HPC-YS5014, XQB60-M1268 关爱, XPM30-2008, 海尔电热水器EC6003-G, 海尔空调KFR-23GW/07ZFT13-DS套机, BCD-539WT(惠民), MOOKA彩电U50H7, EC4002-Q6, 海尔冰箱健康卫士JZW-A01U1, 海尔吸油烟机CXW-200-JH901, D40MF7090定制, BC-93LTMPA, 海尔空调KFR-33GW/07ZFT13-DS套机, ES50H-G1(E), 海尔 冰箱 BCD-235STBA, BCD-196TMPI, KFR-26GW/05GJC23A-DS套机, 海尔波轮洗衣机XQS70-Z9288 至爱, 海尔冰箱BC-50TMPR, 海尔滚筒洗衣机XQG70-B12866, 海尔吸油烟机CXW-219-JT901A, 海尔冰箱BCD-118TMPA, 32EU3000, 海尔冰箱BCD-216SDN, 海尔mini洗衣机iwash-1w, CXW-200-E900T7, 海尔电热水器ES50H-Q1(ZE), 海尔电磁炉众筹D50MF5000, 海尔吸油烟机CXW-200-E900C2, XQG60-1000J, 统帅冰箱BCD-649WLD, XQG70-1012 家家爱, 海尔冰箱BCD-133TMPR, XQG70-1000J, 海尔彩电32EU3000, 海尔彩电众筹D50MF5000, XQB50-728E, XQB60-M1038, TS40M, 海尔挂烫机HGS-2034, KFR-26GW/01GBC13T套机, 海尔燃气热水器JSQ20-UT(12T), 海尔冰箱BCD-206STPA, 海尔冰箱BCD-539WT(惠民), 海尔电风扇FSJ4021E, 海尔滚筒洗衣机XQG60-1000J, BCD-216SDN, 海尔冰箱BCD-225SFM, EC6002-R, XPB70-227HS 关爱, XQG60-BS1086AM, 海尔波轮洗衣机XQS60-Z9288 至爱, 海尔 冰箱 BCD-216SDN, CXW-200-LJC75, 海尔冰箱BCD-225SCZM, 海尔滚筒洗衣机XQG70-1000J, 海尔波轮洗衣机XPB65-1186BS AM, XQB70-M1268 关爱, MW-PQ28SW, BCD-118TMPA, 海尔电热水器小厨宝ES6.6U(W), 32DA3300, 海尔电热水器ES60H-Z4(ZE), 海尔空调KFR-72LW/07EAC12(茉莉白)套机, KFR-23GW/07ZFT13-DS套机, XPB85-287S 关爱, XQG60-812 家家爱, KFR-35GW/05GJC23A-DS套机, XQS60-Z9288 至爱, KFR-35GW/05GCC23AT套机, 海尔波轮洗衣机XQB55-M1268 关爱, BCD-231WDBB, BC/BD-103HA, 海尔吸尘器ZW1608, 统帅彩电 TS40M, 海尔除螨仪ZB401G, XPM26-0701, 统帅冰箱BCD-206LST, 海尔挂烫机HGS-2417, 海尔滚筒洗衣机XQG60-BS1086AM, 海尔波轮洗衣机XQB60-M1038, 海尔波轮洗衣机MS70-BZ1528, MOOKA彩电 U50H7[U50H+ZPB-TS66（底座）底座套餐], 海尔彩电32DA3300, D48MF7000, 统帅冰箱BCD-539WL, BCD-206LST, XQS70-Z9288 至爱, 海尔滚筒洗衣机XQG60-812 家家爱, BCD-225SLDA, TS48, MOOKA彩电55A5, 海尔冰箱BCD-215SECR, 统帅彩电众筹D50MF5000, 海尔电磁炉C21-T2305, 海尔电热水器EC6002-R, BCD-225SFM, CXW-200-JH901, 海尔酒柜JC-46, 海尔冰箱BC-50ES, BCD-133ES, 统帅彩电TS40经典版, KFR-35GW/01GBC13T套机, 海尔电热水器EC5002-D, JSQ20-UT(12T), XQB60-728E, 海尔空调KFR-26GW/07ZFT23A-DS套机, BCD-182LTMPA, BCD-206STPA, 海尔冰箱BCD-225SLDA, EC5002-D, 海尔原汁机众筹HYZ-101A, XPB65-1186BS AM, 海尔冰箱BCD-133ES, 海尔波轮洗衣机XQB60-728E]                                                                                                                                           |
    //|675      |[海尔空调KFR-35GW/05GJC23A-DS套机, 海尔冰箱BCD-228S1白, 海尔彩电40DH6000, 统帅投影仪众筹isee mini 1S, 海尔冰箱BCD-196TMPI, XQB55-M1268 关爱, 海尔冰箱BCD-231WDBB, XQS60-828F  至爱, XQB50-M1268 关爱, TS40经典版, 海尔波轮洗衣机XQB50-M1268 关爱, BC-50ES, 40A5, XQBM20-10EW, 海尔滚筒洗衣机 XQG70-1012 家家爱[BCD-225SEVF-ES+XQG70-1012 家家爱], 海尔波轮洗衣机XPB85-287S 关爱, ES60H-Q1(ZE), 海尔电热水器EC5002-Q6, CXW-200-C150, BC-93TMPF, XQB50-M1258关爱, XQB60-M1268 关爱, 统帅彩电TS40M, XPM30-2008, 海尔电热水器EC6003-G, 海尔空调KFR-23GW/07ZFT13-DS套机, BCD-539WT(惠民), 统帅空调KFR-35GW/01GBC13T套机, BCD-225SCZM, 海尔吸尘器ZB75-3, 统帅彩电D48MF7000, 海尔蒸汽拖把HQ-B1501A, 海尔空调KFR-33GW/07ZFT13-DS套机, 海尔空调KFR-35GW/07ZFT23A-DS套机, BCD-196TMPI, KFR-26GW/05GJC23A-DS套机, KFR-35GW/05KBP22A(DS)套机, 海尔波轮洗衣机XQS70-Z9288 至爱, XPBM16-0501P, 海尔电热水器EC8002-D, ZPB-TS70, MOOKA彩电48A5, 海尔冰箱BCD-118TMPA, 32EU3000, 海尔冰箱BCD-216SDN, 海尔mini洗衣机iwash-1w, MOOKA3D眼镜 HSG7000RFA[mooka50寸全套餐], 海尔电磁炉众筹D50MF5000, 海尔冰箱 BCD-225SEVF-ES[BCD-225SEVF-ES+XQG70-1012 家家爱], 海尔电熨斗HSR-1102L, XQG60-1000J, 统帅冰箱BCD-649WLD, XQG70-1012 家家爱, MOOKA彩电U42H7030, KZW-A01U1空气盒子样壳, XQG70-1000J, 海尔彩电32EU3000, 海尔彩电众筹D50MF5000, XQB60-M1038, TS40M, 海尔冷柜BC/BD-202HT, 统帅彩电D50MF5000, 海尔燃气热水器JSQ20-UT(12T), 海尔电热水器EC6002-D, 海尔冰箱BCD-206STPA, 海尔冰箱BCD-539WT(惠民), 海尔空调KFR-50LW/01NAF13套机, 海尔滚筒洗衣机XQG60-1000J, BCD-216SDN, 海尔冰箱BCD-225SFM, EC6002-R, 海尔波轮洗衣机XQB60-M1268 关爱, 海尔冰箱BCD-221TMBA, EC6002-D, XQG60-BS1086AM, 海尔波轮洗衣机XQS60-Z9288 至爱, CXW-200-LJC75, D50MF5000, 海尔彩电底座 ZPB-TS66[mooka50寸全套餐], 海尔滚筒洗衣机XQG70-1000J, BCD-118TMPA, 海尔空调KFR-72LW/07EAC12(茉莉白)套机, XQG70-B12866, XPB85-287S 关爱, XQG60-812 家家爱, XQG50-810A 关爱, KFR-32GW/01GJC13-DS套机, KFR-35GW/05GJC23A-DS套机, XQS60-Z9288 至爱, 海尔波轮洗衣机XQB55-M1268 关爱, BCD-231WDBB, 海尔豆浆机DJ12B-S03B, 统帅冰箱BCD-206LST, 海尔波轮洗衣机XQB60-M1038, 海尔电水壶HKT-2710B, 统帅冰箱BCD-305WLV, 海尔波轮洗衣机MS70-BZ1528, 海尔电热水器EC5002-R, MOOKA彩电 U50H7[U50H+ZPB-TS66（底座）底座套餐], 海尔彩电32DA3300, D48MF7000, 海尔除螨仪ZB403F, 海尔冰箱BCD-215SFES, XQS70-Z9288 至爱, BCD-206LST, BCD-225SLDA, 统帅彩电众筹D50MF5000, 海尔电热水器EC6002-R, BC/BD-102HT, BCD-225SFM, CXW-200-JH901, KFR-50LW/01CCC12T套机, LES40H-C(E), JSQ24-UT(12T), BCD-133ES, 统帅彩电TS40经典版, KFR-35GW/01GBC13T套机, 海尔电热水器EC5002-D, BCD-225SEVF-ES, 海尔mini洗衣机XQBM20-10EW, XQB60-728E, 海尔空调KFR-26GW/07ZFT23A-DS套机, BCD-206STPA, 海尔原汁机众筹HYZ-101A, XPB65-1186BS AM, 海尔冰箱BCD-133ES, 海尔波轮洗衣机XQB60-728E]                                                                                                                                                                                                                                 |

    //3
    //用户购买商品与最多的商品种类
    val user_bought_goods_df = good_order.select('member_id, 'product_name, 'order_status, 'product_type)
      .where('order_status === "202")
      .groupBy("member_id", "product_type")
      .agg(collect_set('product_name).cast("string") as "good_bought", count("product_type") as "count")
      .withColumn("row_num", row_number() over Window.partitionBy('member_id).orderBy('count.desc))
      .where('row_num === 1)
      .drop("count", "row_num")
    //
    //    user_bought_goods_df.show(false)
    //show
    //+---------+------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    //|member_id|product_type|good_bought                                                                                                                                                                                                                                                                                                           |
    //+---------+------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    //|467      |其他        |[海尔冰箱BCD-228S1白, KFR-26GW/05GJC23A-DS套机, XQB50-M1258关爱, XPB70-227HS 关爱, XQG70-1012 家家爱, 海尔滚筒洗衣机XQG70-1012 家家爱, XQG70-1000J, XQG60-BS1086AM, 海尔 冰箱 BCD-216SDN, TS40M, TS48, MOOKA彩电55A5, XQBM20-10EW, 海尔冰箱BCD-133ES]                                                                 |
    //|675      |其他        |[D48MF7000, XQB60-M1268 关爱, KZW-A01U1空气盒子样壳, EC6002-D, XQS60-Z9288 至爱, BCD-539WT(惠民), 统帅投影仪众筹isee mini 1S, ZPB-TS70, 海尔冰箱BCD-231WDBB, XQB60-M1038, 海尔冰箱BCD-118TMPA, 海尔mini洗衣机iwash-1w, BCD-118TMPA, 统帅彩电众筹D50MF5000, 海尔电水壶HKT-2710B, BC/BD-102HT, 海尔波轮洗衣机XQB60-728E]|
    //|691      |其他        |[BCD-216SDN, XPB85-287S 关爱, KFR-32GW/01GJC13-DS套机, XQG70-1012 家家爱, 海尔电视D48MF7000, XQG70-1000J, 海尔彩电众筹D50MF5000, 海尔波轮洗衣机XQB55-M1268 关爱, XQB50-728E, XQB60-M1038, MOOKA彩电48A5, TS40M, XQB50-M1268 关爱, 海尔电磁炉众筹D50MF5000, XQG70-B12866]                                              |
    //4
    val band_prefer_df = good_order.select('member_id, 'product_name, 'order_status,
      when('product_name like "%卡萨帝%", "卡萨帝")
        .when('product_name like "%MOOKA%", "摩卡")
        .when('product_name like "%KFR%", "小超人")
        .when('product_name like "%统帅%", "统帅")
        .when('product_name like "%海尔%", "海尔")
        .otherwise("其他")
        .as("brand_preference"))
      .where('order_status === "202")
      .groupBy("member_id", "brand_preference")
      .agg(sum(when('brand_preference === "其他", 3).when('brand_preference === "海尔", 3).otherwise(10)) as "count")
      .withColumn("row_num", row_number() over Window.partitionBy('member_id).orderBy('count.desc))
      .where('row_num === 1)
      .drop("count", "row_num")
    band_prefer_df.show(false)

    //5
    //用户购买最多的商品
    val user_buy_most_df = good_order.select('member_id, 'product_name, 'order_status)
      .where('order_status === "202")
      .groupBy("member_id", "product_name")
      .agg(count("product_name") as "count")
      .withColumn("row_num", row_number() over Window.partitionBy('member_id).orderBy('count.desc))
      .where('row_num === 1)
      .drop("count", "row_num")

    var res1_df = user_scanned_goods_df.join(user_bought_goods_df, user_scanned_goods_df.col("member_id") === user_bought_goods_df.col("member_id"))
      .drop(user_bought_goods_df.col("member_id"))

    var res2_df = res1_df.join(band_prefer_df, band_prefer_df.col("member_id") === res1_df.col("member_id"))
      .drop(band_prefer_df.col("member_id"))

    var res3_df = res2_df.join(user_buy_most_df, user_buy_most_df.col("member_id") === res2_df.col("member_id"))
      .drop(user_buy_most_df.col("member_id"))

//    res3_df.show(false)
    //+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------+------------------------------+
    //|scanned_goods                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |member_id|product_type|good_bought                                                                                                                                                                                                                                                                                                           |brand_preference|product_name                  |
    //+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------+------------------------------+
    //|[海尔冰箱BCD-228S1白, 海尔滚筒洗衣机XQG70-1012 家家爱, XQB55-Z1269, 统帅投影仪众筹isee mini 1S, 海尔冰箱BCD-196TMPI, 海尔冰箱BCD-231WDBB, XQB50-M1268 关爱, XQS60-Z9288  至爱, 海尔冰箱BC-93TMPF, TS40经典版, 海尔电磁炉 C21-H2110, 海尔波轮洗衣机XQB50-M1268 关爱, BC-50ES, 海尔滚筒洗衣机XQG60-S1086AM, XQBM20-10EW, 海尔波轮洗衣机XPB85-287S 关爱, XPB70-287BS 关爱, 统帅彩电TS48, 海尔空调KFR-35GW/05KBP22A(DS)套机, 海尔滚筒洗衣机XQG70-B10288, XQB50-M1258关爱, 海尔电压力锅HPC-YS5014, XQB60-M1268 关爱, XPM30-2008, 海尔电热水器EC6003-G, 海尔空调KFR-23GW/07ZFT13-DS套机, BCD-539WT(惠民), MOOKA彩电U50H7, EC4002-Q6, 海尔冰箱健康卫士JZW-A01U1, 海尔吸油烟机CXW-200-JH901, D40MF7090定制, BC-93LTMPA, 海尔空调KFR-33GW/07ZFT13-DS套机, ES50H-G1(E), 海尔 冰箱 BCD-235STBA, BCD-196TMPI, KFR-26GW/05GJC23A-DS套机, 海尔波轮洗衣机XQS70-Z9288 至爱, 海尔冰箱BC-50TMPR, 海尔滚筒洗衣机XQG70-B12866, 海尔吸油烟机CXW-219-JT901A, 海尔冰箱BCD-118TMPA, 32EU3000, 海尔冰箱BCD-216SDN, 海尔mini洗衣机iwash-1w, CXW-200-E900T7, 海尔电热水器ES50H-Q1(ZE), 海尔电磁炉众筹D50MF5000, 海尔吸油烟机CXW-200-E900C2, XQG60-1000J, 统帅冰箱BCD-649WLD, XQG70-1012 家家爱, 海尔冰箱BCD-133TMPR, XQG70-1000J, 海尔彩电32EU3000, 海尔彩电众筹D50MF5000, XQB50-728E, XQB60-M1038, TS40M, 海尔挂烫机HGS-2034, KFR-26GW/01GBC13T套机, 海尔燃气热水器JSQ20-UT(12T), 海尔冰箱BCD-206STPA, 海尔冰箱BCD-539WT(惠民), 海尔电风扇FSJ4021E, 海尔滚筒洗衣机XQG60-1000J, BCD-216SDN, 海尔冰箱BCD-225SFM, EC6002-R, XPB70-227HS 关爱, XQG60-BS1086AM, 海尔波轮洗衣机XQS60-Z9288 至爱, 海尔 冰箱 BCD-216SDN, CXW-200-LJC75, 海尔冰箱BCD-225SCZM, 海尔滚筒洗衣机XQG70-1000J, 海尔波轮洗衣机XPB65-1186BS AM, XQB70-M1268 关爱, MW-PQ28SW, BCD-118TMPA, 海尔电热水器小厨宝ES6.6U(W), 32DA3300, 海尔电热水器ES60H-Z4(ZE), 海尔空调KFR-72LW/07EAC12(茉莉白)套机, KFR-23GW/07ZFT13-DS套机, XPB85-287S 关爱, XQG60-812 家家爱, KFR-35GW/05GJC23A-DS套机, XQS60-Z9288 至爱, KFR-35GW/05GCC23AT套机, 海尔波轮洗衣机XQB55-M1268 关爱, BCD-231WDBB, BC/BD-103HA, 海尔吸尘器ZW1608, 统帅彩电 TS40M, 海尔除螨仪ZB401G, XPM26-0701, 统帅冰箱BCD-206LST, 海尔挂烫机HGS-2417, 海尔滚筒洗衣机XQG60-BS1086AM, 海尔波轮洗衣机XQB60-M1038, 海尔波轮洗衣机MS70-BZ1528, MOOKA彩电 U50H7[U50H+ZPB-TS66（底座）底座套餐], 海尔彩电32DA3300, D48MF7000, 统帅冰箱BCD-539WL, BCD-206LST, XQS70-Z9288 至爱, 海尔滚筒洗衣机XQG60-812 家家爱, BCD-225SLDA, TS48, MOOKA彩电55A5, 海尔冰箱BCD-215SECR, 统帅彩电众筹D50MF5000, 海尔电磁炉C21-T2305, 海尔电热水器EC6002-R, BCD-225SFM, CXW-200-JH901, 海尔酒柜JC-46, 海尔冰箱BC-50ES, BCD-133ES, 统帅彩电TS40经典版, KFR-35GW/01GBC13T套机, 海尔电热水器EC5002-D, JSQ20-UT(12T), XQB60-728E, 海尔空调KFR-26GW/07ZFT23A-DS套机, BCD-182LTMPA, BCD-206STPA, 海尔冰箱BCD-225SLDA, EC5002-D, 海尔原汁机众筹HYZ-101A, XPB65-1186BS AM, 海尔冰箱BCD-133ES, 海尔波轮洗衣机XQB60-728E]                                                                                                                                           |467      |其他        |[海尔冰箱BCD-228S1白, KFR-26GW/05GJC23A-DS套机, XQB50-M1258关爱, XPB70-227HS 关爱, XQG70-1012 家家爱, 海尔滚筒洗衣机XQG70-1012 家家爱, XQG70-1000J, XQG60-BS1086AM, 海尔 冰箱 BCD-216SDN, TS40M, TS48, MOOKA彩电55A5, XQBM20-10EW, 海尔冰箱BCD-133ES]                                                                 |其他            |BCD-206STPA                   |
    //|[海尔空调KFR-35GW/05GJC23A-DS套机, 海尔冰箱BCD-228S1白, 海尔彩电40DH6000, 统帅投影仪众筹isee mini 1S, 海尔冰箱BCD-196TMPI, XQB55-M1268 关爱, 海尔冰箱BCD-231WDBB, XQS60-828F  至爱, XQB50-M1268 关爱, TS40经典版, 海尔波轮洗衣机XQB50-M1268 关爱, BC-50ES, 40A5, XQBM20-10EW, 海尔滚筒洗衣机 XQG70-1012 家家爱[BCD-225SEVF-ES+XQG70-1012 家家爱], 海尔波轮洗衣机XPB85-287S 关爱, ES60H-Q1(ZE), 海尔电热水器EC5002-Q6, CXW-200-C150, BC-93TMPF, XQB50-M1258关爱, XQB60-M1268 关爱, 统帅彩电TS40M, XPM30-2008, 海尔电热水器EC6003-G, 海尔空调KFR-23GW/07ZFT13-DS套机, BCD-539WT(惠民), 统帅空调KFR-35GW/01GBC13T套机, BCD-225SCZM, 海尔吸尘器ZB75-3, 统帅彩电D48MF7000, 海尔蒸汽拖把HQ-B1501A, 海尔空调KFR-33GW/07ZFT13-DS套机, 海尔空调KFR-35GW/07ZFT23A-DS套机, BCD-196TMPI, KFR-26GW/05GJC23A-DS套机, KFR-35GW/05KBP22A(DS)套机, 海尔波轮洗衣机XQS70-Z9288 至爱, XPBM16-0501P, 海尔电热水器EC8002-D, ZPB-TS70, MOOKA彩电48A5, 海尔冰箱BCD-118TMPA, 32EU3000, 海尔冰箱BCD-216SDN, 海尔mini洗衣机iwash-1w, MOOKA3D眼镜 HSG7000RFA[mooka50寸全套餐], 海尔电磁炉众筹D50MF5000, 海尔冰箱 BCD-225SEVF-ES[BCD-225SEVF-ES+XQG70-1012 家家爱], 海尔电熨斗HSR-1102L, XQG60-1000J, 统帅冰箱BCD-649WLD, XQG70-1012 家家爱, MOOKA彩电U42H7030, KZW-A01U1空气盒子样壳, XQG70-1000J, 海尔彩电32EU3000, 海尔彩电众筹D50MF5000, XQB60-M1038, TS40M, 海尔冷柜BC/BD-202HT, 统帅彩电D50MF5000, 海尔燃气热水器JSQ20-UT(12T), 海尔电热水器EC6002-D, 海尔冰箱BCD-206STPA, 海尔冰箱BCD-539WT(惠民), 海尔空调KFR-50LW/01NAF13套机, 海尔滚筒洗衣机XQG60-1000J, BCD-216SDN, 海尔冰箱BCD-225SFM, EC6002-R, 海尔波轮洗衣机XQB60-M1268 关爱, 海尔冰箱BCD-221TMBA, EC6002-D, XQG60-BS1086AM, 海尔波轮洗衣机XQS60-Z9288 至爱, CXW-200-LJC75, D50MF5000, 海尔彩电底座 ZPB-TS66[mooka50寸全套餐], 海尔滚筒洗衣机XQG70-1000J, BCD-118TMPA, 海尔空调KFR-72LW/07EAC12(茉莉白)套机, XQG70-B12866, XPB85-287S 关爱, XQG60-812 家家爱, XQG50-810A 关爱, KFR-32GW/01GJC13-DS套机, KFR-35GW/05GJC23A-DS套机, XQS60-Z9288 至爱, 海尔波轮洗衣机XQB55-M1268 关爱, BCD-231WDBB, 海尔豆浆机DJ12B-S03B, 统帅冰箱BCD-206LST, 海尔波轮洗衣机XQB60-M1038, 海尔电水壶HKT-2710B, 统帅冰箱BCD-305WLV, 海尔波轮洗衣机MS70-BZ1528, 海尔电热水器EC5002-R, MOOKA彩电 U50H7[U50H+ZPB-TS66（底座）底座套餐], 海尔彩电32DA3300, D48MF7000, 海尔除螨仪ZB403F, 海尔冰箱BCD-215SFES, XQS70-Z9288 至爱, BCD-206LST, BCD-225SLDA, 统帅彩电众筹D50MF5000, 海尔电热水器EC6002-R, BC/BD-102HT, BCD-225SFM, CXW-200-JH901, KFR-50LW/01CCC12T套机, LES40H-C(E), JSQ24-UT(12T), BCD-133ES, 统帅彩电TS40经典版, KFR-35GW/01GBC13T套机, 海尔电热水器EC5002-D, BCD-225SEVF-ES, 海尔mini洗衣机XQBM20-10EW, XQB60-728E, 海尔空调KFR-26GW/07ZFT23A-DS套机, BCD-206STPA, 海尔原汁机众筹HYZ-101A, XPB65-1186BS AM, 海尔冰箱BCD-133ES, 海尔波轮洗衣机XQB60-728E]                                                                                                                                                                                                                                 |675      |其他        |[D48MF7000, XQB60-M1268 关爱, KZW-A01U1空气盒子样壳, EC6002-D, XQS60-Z9288 至爱, BCD-539WT(惠民), 统帅投影仪众筹isee mini 1S, ZPB-TS70, 海尔冰箱BCD-231WDBB, XQB60-M1038, 海尔冰箱BCD-118TMPA, 海尔mini洗衣机iwash-1w, BCD-118TMPA, 统帅彩电众筹D50MF5000, 海尔电水壶HKT-2710B, BC/BD-102HT, 海尔波轮洗衣机XQB60-728E]|其他            |海尔彩电众筹D50MF5000         |
    //|[海尔冰箱BCD-235STBA, 海尔彩电40DH6000, 海尔空调KFR-35GW/05GJC23A-DS套机, 海尔滚筒洗衣机XQG70-1012 家家爱, 海尔冰箱 BCD-215SECR, 统帅投影仪众筹isee mini 1S, BCD-215SFES, 海尔冰箱BCD-196TMPI, XQB55-M1268 关爱, XQB50-M1268 关爱, 海尔冰箱BC-93TMPF, TS40经典版, KFR-35GW/01GJC13-DS套机, 海尔波轮洗衣机XQB50-M1268 关爱, BC-50ES, 海尔波轮洗衣机XQB50-728E, 海尔吸油烟机 CXW-180-JS721[CXW-180-JS721/JZT-QE3B(12T)], XQBM20-10EW, 海尔波轮洗衣机XPB85-287S 关爱, LES60H-C(E), MS70-BZ1528, 海尔空调KFR-35GW/05KBP22A(DS)套机, 海尔电热水器EC5002-Q6, XQB50-M1258关爱, 海尔电压力锅HPC-YS5014, XQB60-M1268 关爱, XPM30-2008, 海尔空调KFR-23GW/07ZFT13-DS套机, BCD-539WT(惠民), 统帅空调KFR-35GW/01GBC13T套机, 海尔冰箱健康卫士JZW-A01U1, JZT-QE6GD2(12T), 海尔空调KFR-33GW/07ZFT13-DS套机, 48A5, BCD-196TMPI, 海尔吸尘器ZW1200-201 虚网, 海尔波轮洗衣机XPB70-227HS 关爱, KFR-26GW/05GJC23A-DS套机, KFR-35GW/05KBP22A(DS)套机, 海尔电视D48MF7000, 海尔滚筒洗衣机XQG70-B12866, MOOKA彩电48A5, 海尔冰箱BCD-118TMPA, 统帅投影仪iSee mini 1S, XPB70-227HS  关爱, 32EU3000, 海尔mini洗衣机iwash-1w, 海尔燃气灶JZT-QE3G(12T), iwash-1w, 海尔电磁炉众筹D50MF5000, 统帅彩电 LE32MUK1, 海尔空调KFR-50LW/06ZDC13-DS套机, XQG60-1000J, MOOKA彩电 U42H7030[MOOKA智能电视U42H7030+HSG7000RFA（3D眼镜）], XQG70-1012 家家爱, KZW-A01U1空气盒子样壳, 海尔冰箱BCD-133TMPR, XQG70-1000J, 海尔彩电32EU3000, XQB50-M1268关爱 （小神童）, 海尔彩电众筹D50MF5000, 海尔电熨斗YD1301 虚网, XQB50-728E, XQB60-M1038, TS40M, 海尔冰箱BCD-186KB, 海尔冷柜BC/BD-202HT, KFR-26GW/01GBC13T套机, 海尔燃气热水器JSQ20-UT(12T), 海尔电热水器EC6002-D, 海尔吸油烟机CXW-200-C150, 海尔冰箱BCD-206STPA, 海尔电风扇FSJ4021E, BCD-216SDN, 海尔冰箱BCD-225SFM, EC6002-R, EC6002-D, ZW1608, 海尔波轮洗衣机XQS60-Z9288 至爱, 海尔彩电底座 ZPB-TS66[mooka50寸全套餐], 海尔冰箱BCD-225SCZM, 海尔滚筒洗衣机XQG70-1000J, XQB70-M1268 关爱, 海尔空气净化器 空气净化器KJ-F200/CA(白), BC/BD-202HT, 海尔空调KFR-35GW/01GJC13-DS套机, BCD-118TMPA, 海尔微波炉MZW-2070EGCZ, XQG70-B12866, XPB85-287S 关爱, XQG60-812 家家爱, KFR-32GW/01GJC13-DS套机, KFR-35GW/05GJC23A-DS套机, XQS60-Z9288 至爱, CXW-180-JS721, 海尔波轮洗衣机XQB55-M1268 关爱, 统帅冰箱BCD-206LST, 海尔燃气热水器JSQ24-UT(12T), 海尔滚筒洗衣机XQG60-BS1086AM, 小厨宝ES6.6U(W), 海尔波轮洗衣机XQB70-M1268 关爱, 海尔波轮洗衣机 XQB50-M1258关爱, 海尔电磁炉C21-H2106 专供, 海尔手机HL-6170T手机(钢琴白), 海尔彩电32DA3300, D48MF7000, 海尔原汁机HYZ-101A, 海尔滚筒洗衣机XQG60-B10288, BCD-206LST, XQS70-Z9288 至爱, MOOKA3D眼镜 HSG7000RFA[mooka50寸眼镜套餐], BCD-228S1白, TS48, MOOKA彩电55A5, BCD-539WL, 统帅彩电众筹D50MF5000, 海尔电热水器EC6002-R, BCD-225SFM, 海尔mini洗衣机XPM30-2008, 海尔冰箱BC-50ES, BCD-133ES, 统帅彩电TS40经典版, KFR-35GW/01GBC13T套机, 海尔电热水器EC5002-D, 海尔空调KFR-26GW/05GJC23A-DS套机, XQB60-728E, 海尔空调KFR-26GW/07ZFT23A-DS套机, BCD-206STPA, 海尔原汁机众筹HYZ-101A, XPB65-1186BS AM, 海尔冰箱BCD-133ES, DPF-801D（雪白色）, 海尔波轮洗衣机XQB60-728E]|691      |其他        |[BCD-216SDN, XPB85-287S 关爱, KFR-32GW/01GJC13-DS套机, XQG70-1012 家家爱, 海尔电视D48MF7000, XQG70-1000J, 海尔彩电众筹D50MF5000, 海尔波轮洗衣机XQB55-M1268 关爱, XQB50-728E, XQB60-M1038, MOOKA彩电48A5, TS40M, XQB50-M1268 关爱, 海尔电磁炉众筹D50MF5000, XQG70-B12866]                                              |海尔            |TS40M                         |

    def goods_catalog_write =
      s"""{
         |"table":{"namespace":"default", "name":"user_goods_and_order"},
         |"rowkey":"member_id",
         |"columns":{
         |"member_id":{"cf":"rowkey", "col":"member_id", "type":"string"},
         |"scanned_goods":{"cf":"cf", "col":"scanned_goods", "type":"string"},
         |"product_type":{"cf":"cf", "col":"product_type", "type":"string"},
         |"good_bought":{"cf":"cf", "col":"good_bought", "type":"string"},
         |"brand_preference":{"cf":"cf", "col":"brand_preference", "type":"string"},
         |"product_name":{"cf":"cf", "col":"productName", "type":"string"}
         |}
         |}""".stripMargin

    res3_df.write
      .option(HBaseTableCatalog.tableCatalog, goods_catalog_write)
      .option(HBaseTableCatalog.newTable, "5")
      .format("org.apache.spark.sql.execution.datasources.hbase")
      .save()
  }

  def string_last_3_char(str:String):String = {
    val len = str.length
    val sub_str = if(len > 3) str.substring(len-3,len) else str
    if(sub_str(0)=='0' && sub_str(1)=='0') sub_str.substring(2)
    else if(sub_str(0)=='0') sub_str.substring(1,3)
    else sub_str
  }
}